schema: '2.0'
stages:
  prepare_dataset:
    cmd: python -m mllam_data_prep data/datastore.yaml --output data/datastore.zarr
    deps:
    - path: data/datastore.yaml
      hash: md5
      md5: 69fe3c7d4618efaa4e819e5b7d01fc09
      size: 2331
    outs:
    - path: data/datastore.zarr
      hash: md5
      md5: 8fd9f4688b6dc136245939edb5087bff.dir
      size: 129680003233
      nfiles: 58550
  create_graph:
    cmd: python -m neural_lam.create_graph --config_path data/config.yaml --name 1level
      --levels 1
    params:
      data/config.yaml:
        datastore:
          kind: mdp
          config_path: ../data/datastore.yaml
    outs:
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
  train:
    cmd:
    - sbatch -W machines/slurm.train.sh --config_path $PWD/data/config.yaml --logger
      mlflow
    deps:
    - path: data/config.yaml
      hash: md5
      md5: 20d97bfb85f27553e03d8662a5c73a2b
      size: 143
    - path: data/datastore.yaml
      hash: md5
      md5: 69fe3c7d4618efaa4e819e5b7d01fc09
      size: 2331
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
    - path: versions.yaml
      hash: md5
      md5: fa41f3e4a6e28b5a03c69af85ba9a599
      size: 22
    params:
      data/training_params.yaml:
        batch_size: 10
        epochs: 30
        graph: 1level
        hidden_dim: 16
        metrics_watch: val_rmse, mse, random_metric
        model: graph_lam
        num_nodes: 10
        num_workers: 16
        processor_layers: 2
        val_steps_to_log: 5
    outs:
    - path: saved_models
      hash: md5
      md5: 506183832cb1bd4a0cfcb54be8b674e2.dir
      size: 471392
      nfiles: 2
  evaluate:
    cmd:
    - module load slurm; sbatch -W machines/slurm.train.sh --config_path $PWD/data/config.yaml
      --eval val --load $PWD/saved_models/*/last.ckpt
    deps:
    - path: data/config.yaml
      hash: md5
      md5: 3ff6fd5c3978e5e8903a47af33afccb4
      size: 60
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
    - path: data/training/dataset.zarr
      hash: md5
      md5: 9e9e15de76a3ad614ce2ae2427d5eab0.dir
      size: 2382248042
      nfiles: 2006
    - path: saved_models
      hash: md5
      md5: c9a2946e176777db1d671dcbea9177db.dir
      size: 276704
      nfiles: 2
    - path: versions.yaml
      hash: md5
      md5: fa41f3e4a6e28b5a03c69af85ba9a599
      size: 22
    params:
      data/training_params.yaml:
        batch_size: 1
        epochs: 1
        graph: 1level
        hidden_dim: 8
        logger: dvc
        metrics_watch: val_rmse, mse, random_metric
        model: graph_lam
        num_workers: 1
        processor_layers: 2
        val_steps_to_log: 1
  create_graph-slurm:
    cmd: python -m neural_lam.create_graph --config_path data/config.yaml --name 1level
      --levels 1
    deps:
    - path: data/datastore.zarr
      hash: md5
      md5: 8fd9f4688b6dc136245939edb5087bff.dir
      size: 129680003233
      nfiles: 58550
    params:
      data/config.yaml:
        datastore:
          kind: mdp
          config_path: ../data/datastore.yaml
    outs:
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
  train-slurm:
    cmd:
    - sbatch -W machines/slurm.train.sh --config_path $PWD/data/config.yaml
    deps:
    - path: data/config.yaml
      hash: md5
      md5: 20d97bfb85f27553e03d8662a5c73a2b
      size: 143
    - path: data/datastore.yaml
      hash: md5
      md5: 69fe3c7d4618efaa4e819e5b7d01fc09
      size: 2331
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
    - path: versions.yaml
      hash: md5
      md5: fa41f3e4a6e28b5a03c69af85ba9a599
      size: 22
    params:
      data/training_params.yaml:
        batch_size: 20
        epochs: 2
        graph: 1level
        hidden_dim: 8
        logger: mlflow
        metrics_watch: val_rmse, mse, random_metric
        model: graph_lam
        processor_layers: 2
        val_steps_to_log: 1
    outs:
    - path: saved_models
      hash: md5
      md5: 0777a038d6a8824506914fb1440d51d8.dir
      size: 277984
      nfiles: 2
