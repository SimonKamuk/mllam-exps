schema: '2.0'
stages:
  prepare_dataset:
    cmd: python -m mllam_data_prep data/datastore.yaml --output data/datastore.zarr
    deps:
    - path: data/datastore.yaml
      hash: md5
      md5: c9050d1fb6fa102831b932f9b8d75156
      size: 2787
      isexec: true
    outs:
    - path: data/datastore.zarr
      hash: md5
      md5: 834a336a26236b6eef584215ee208f52.dir
      size: 117823372641
      nfiles: 58550
  create_graph:
    cmd: python -m neural_lam.create_graph --config_path data/config.yaml --name 1level
      --levels 1
    params:
      data/config.yaml:
        datastore:
          kind: mdp
          config_path: ../data/datastore.yaml
    outs:
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
  train:
    cmd:
    - sbatch -W machines/slurm.train.sh --config_path ./data/config.yaml --logger
      mlflow
    deps:
    - path: data/config.yaml
      hash: md5
      md5: 20d97bfb85f27553e03d8662a5c73a2b
      size: 143
    - path: data/datastore.yaml
      hash: md5
      md5: c9050d1fb6fa102831b932f9b8d75156
      size: 2787
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
    - path: version.mllam.txt
      hash: md5
      md5: 6f7f7eeb355cdd6fb6f5a48acf34e158
      size: 29
    params:
      data/training_params.yaml:
        batch_size: 10
        epochs: 30
        graph: 1level
        hidden_dim: 16
        metrics_watch: val_rmse, mse, random_metric
        model: graph_lam
        num_nodes: 10
        num_workers: 16
        processor_layers: 2
        val_steps_to_log: 5
    outs:
    - path: saved_models
      hash: md5
      md5: 5850d309b6d467c1b25cfbb42ee8e3e5.dir
      size: 11788552
      nfiles: 164
  evaluate:
    cmd:
    - sbatch -W --nodes 1 machines/slurm.train.sh --config_path ./data/config.yaml
      --eval val --load ./saved_models/*/last.ckpt --logger mlflow
    deps:
    - path: data/config.yaml
      hash: md5
      md5: 20d97bfb85f27553e03d8662a5c73a2b
      size: 143
    - path: data/datastore.yaml
      hash: md5
      md5: c9050d1fb6fa102831b932f9b8d75156
      size: 2787
    - path: data/graph/
      hash: md5
      md5: a6bf314ff9b02c58e05daee9aa9f9e94.dir
      size: 90190870
      nfiles: 7
    - path: saved_models
      hash: md5
      md5: 5850d309b6d467c1b25cfbb42ee8e3e5.dir
      size: 11788552
      nfiles: 164
    - path: version.mllam.txt
      hash: md5
      md5: 6f7f7eeb355cdd6fb6f5a48acf34e158
      size: 29
    params:
      data/evaluate_params.yaml:
        ar_steps_eval: 24
        batch_size: 10
        epochs: 30
        graph: 1level
        hidden_dim: 16
        metrics_watch: val_rmse, mse, random_metric
        model: graph_lam
        num_nodes: 1
        num_workers: 16
        processor_layers: 2
        val_steps_to_log: 5
  mllam_version:
    cmd: source machines/environment.sh; python -c "from neural_lam import __version__;
      print(__version__)" > version.mllam.txt
